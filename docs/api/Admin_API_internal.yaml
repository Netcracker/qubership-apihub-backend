openapi: 3.0.3
info:
  title: APIHUB system administrators API â€“ Internal
  description: |
    Internal-only API contract for system administrators.
  contact:
    name: Netcracker Opensource Group
    email: opensourcegroup@netcracker.com
  license:
    name: qubership
    url: https://github.com/Netcracker/qubership-apihub
  version: "2025.4"
  x-nc-api-audience: BWC
externalDocs:
  description: Find out more about package
  url: https://github.com/Netcracker/qubership-apihub
servers:
  - url: https://{apihub}.qubership.org
    description: APIHUB server
    variables:
      apihub:
        description: Name of the APIHUB server.
        enum:
          - apihub
          - dev.apihub
          - staging.apihub
        default: apihub
security:
  - BearerAuth: []
  - CookieAuth: []
  - api-key: []
  - PersonalAccessToken: []
tags:
  - name: System
    description: System operations
  - name: Debug
    description: Debug operations
  - name: Deleted
    description: Deleted packages operations
  - name: Admin
    description: APIs for technical administration.

paths:
  /api/v2/admin/system/stats:
    get:
      tags:
        - System
      summary: Get system statistics
      description: |
        Retrieves system-wide statistics including business entities count, build statistics, and database size information.
      operationId: getSystemStats
      responses:
        "200":
          description: System statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemStats"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples: {}
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples: {}
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                InternalServerError:
                  $ref: "#/components/examples/InternalServerError"
  /api/v1/debug/logs/checkLevel:
    get:
      tags:
        - Debug
      summary: Check log level
      description: |
        Check current log level.
      operationId: checkLogLevel
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  level:
                    type: string
                    description: Current log level
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/v1/debug/logs/setLevel:
    post:
      tags:
        - Debug
      summary: Set log level
      description: |
        Set log level.
      operationId: setLogLevel
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - level
              properties:
                level:
                  type: string
                  description: Log level to set
                  enum:
                    - panic
                    - fatal
                    - error
                    - warn
                    - info
                    - debug
                    - trace
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  level:
                    type: string
                    description: Current log level
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/v1/deleted/packages:
    get:
      tags:
        - Deleted
      summary: Get deleted packages
      description: |
        Get list of deleted packages.
      operationId: getDeletedPackages
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    packageId:
                      type: string
                    deletedAt:
                      type: string
                      format: date-time
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/v1/deleted/packages/{packageId}/versions:
    get:
      tags:
        - Deleted
      summary: Get deleted package versions
      description: |
        Get list of deleted versions for a package.
      operationId: getDeletedPackageVersions
      parameters:
        - name: packageId
          in: path
          required: true
          description: Package identifier
          schema:
            type: string
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    version:
                      type: string
                    deletedAt:
                      type: string
                      format: date-time
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/v1/deleted/packages/{packageId}/versions/{version}:
    get:
      tags:
        - Deleted
      summary: Get deleted package version
      description: |
        Get deleted version content for a package.
      operationId: getDeletedPackageVersion
      parameters:
        - name: packageId
          in: path
          required: true
          description: Package identifier
          schema:
            type: string
        - name: version
          in: path
          required: true
          description: Version identifier
          schema:
            type: string
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  packageId:
                    type: string
                  version:
                    type: string
                  deletedAt:
                    type: string
                    format: date-time
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  "/api/v1/publishHistory":
    get:
      tags:
        - Admin
      summary: Get history of published version revisions
      description: |
        Returns all existing version revisions sorted by publish date from oldest to newest.
        Only for system administrators.
      operationId: getPublishHistory
      x-api-kind: no-BWC
      parameters:
        - name: status
          description: version status
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/VersionStatusEnum"
        - name: publishedBefore
          description: Filter to include only revisions published before specific date
          in: query
          required: false
          schema:
            type: string
            format: date-time
            description: RFC3339 format
            example: "2024-03-15T12:00:13.052715Z"
        - name: publishedAfter
          description: Filter to include only revisions published after specific date
          in: query
          required: false
          schema:
            type: string
            format: date-time
            description: RFC3339 format
            example: "2024-03-15T12:00:13.052715Z"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                description: List of published versions
                type: array
                items:
                  type: object
                  properties:
                    packageId:
                      type: string
                    version:
                      type: string
                    revision:
                      type: integer
                    previousVersionPackageId:
                      type: string
                    previousVersion:
                      type: string
                    publishedAt:
                      type: string
                      format: date-time
                    apiTypes:
                      type: array
                      items:
                        $ref: "#/components/schemas/ApiType"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                IncorrectInputParams:
                  $ref: "#/components/examples/IncorrectInputParameters"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                InternalServerError:
                  $ref: "#/components/examples/InternalServerError"
  "/api/v2/businessMetrics":
    get:
      tags:
        - Admin
      summary: Get business metrics report
      description: |
        Returns collected business metrics
      operationId: getBusinessMetrics
      parameters:
        - name: format
          description: Response format
          in: query
          required: false
          schema:
            type: string
            default: json
            enum:
            - json
            - xlsx
        - name: parentPackageId
          description: Return business metrics only for specific group\workspace
          in: query
          required: false
          schema:
            type: string
            example: SD
        - name: hierarchyLevel
          description: Number of hierarchy levels for grouping packages (level=0 - packageId="SD.TL.TLQSS", level=1 - packageId="SD", level=2 - packageId="SD.TL")
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                description: List of collected business metrics grouped by package
                type: array
                items:
                  $ref: "#/components/schemas/BusinessMetric"
            application/octet-stream:
              schema:
                type: string
                format: binary
                description: xlsx file to download
          headers:
            Content-Disposition:
              schema:
                type: string
                description: xlsx file name (only filled when format=xlsx)
                example: attachment; filename="business_metrics_2023-12-31.xlsx"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                IncorrectInputParams:
                  $ref: "#/components/examples/IncorrectInputParameters"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                InternalServerError:
                  $ref: "#/components/examples/InternalServerError"
  /api/internal/minio/download:
    post:
      tags:
        - System
      summary: Download files from MINIO to the database
      description: |
        Download files from MINIO storage to the database.
        Only available in non-production mode.
      operationId: downloadFilesFromMinioToDatabase
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                InternalServerError:
                  $ref: "#/components/examples/InternalServerError"

components:
  schemas:
    ErrorResponse:
      description: An error description
      type: object
      properties:
        status:
          description: HTTP Status Code
          type: number
        code:
          description: Internal string error code. Mandatory in response.
          type: string
        message:
          description: The attribute contains an error message.
          type: string
        params:
          type: object
          description: Message parameters
          example:
            id: 12345
            type: string
        debug:
          description: The attribute contains debug details (e.g. stack-trace). Presented in the error response only on Dev/Test environments if corresponding logging level is enabled.
          type: string
      required:
        - status
        - code
        - message
    BuildsCount:
      type: object
      description: Statistics for a specific build type
      properties:
        notStarted:
          type: integer
          description: Number of builds not started
        running:
          type: integer
          description: Number of builds currently running
        failedLastWeek:
          type: integer
          description: Number of builds that failed in the last week
        succeedLastWeek:
          type: integer
          description: Number of builds that succeeded in the last week
        restartsLastWeek:
          type: integer
          description: Number of builds that were restarted in the last week
    SystemStats:
      type: object
      description: System-wide statistics
      properties:
        businessEntities:
          type: object
          description: Counts of various business entities in the system
          properties:
            workspaces:
              type: integer
              description: Number of workspaces
            deletedWorkspaces:
              type: integer
              description: Number of deleted workspaces
            groups:
              type: integer
              description: Number of groups
            deletedGroups:
              type: integer
              description: Number of deleted groups
            packages:
              type: integer
              description: Number of packages
            deletedPackages:
              type: integer
              description: Number of deleted packages
            dashboards:
              type: integer
              description: Number of dashboards
            deletedDashboards:
              type: integer
              description: Number of deleted dashboards
            revisions:
              type: integer
              description: Number of revisions
            deletedRevisions:
              type: integer
              description: Number of deleted revisions
            documents:
              type: integer
              description: Number of documents
            operations:
              type: integer
              description: Number of operations
            versionComparisons:
              type: integer
              description: Number of version comparisons
        builds:
          type: object
          description: |
            Statistics about builds by build type.
          properties:
            build:
              $ref: "#/components/schemas/BuildsCount"
            changelog:
              $ref: "#/components/schemas/BuildsCount"
            documentGroup:
              $ref: "#/components/schemas/BuildsCount"
            exportRestDocument:
              $ref: "#/components/schemas/BuildsCount"
            exportRestOperationsGroup:
              $ref: "#/components/schemas/BuildsCount"
            exportVersion:
              $ref: "#/components/schemas/BuildsCount"
            mergedSpecification:
              $ref: "#/components/schemas/BuildsCount"
            reducedSourceSpecifications:
              $ref: "#/components/schemas/BuildsCount"
        databaseSize:
          type: array
          description: Information about database table sizes
          items:
            type: object
            properties:
              tableName:
                type: string
                description: Name of the database table
              rowEstimate:
                type: number
                format: float
                description: Estimated number of rows in the table
              totalSize:
                type: string
                description: Total size of the table including all related data
              indexSize:
                type: string
                description: Size of the table's indexes
              toastSize:
                type: string
                description: Size of the table's TOAST data
              tableSize:
                type: string
                description: Size of the actual table data
              totalSizeShare:
                type: number
                format: float
                description: Proportion of the total database size that this table uses
    BusinessMetric:
      description: Business metric
      title: BusinessMetric
      required:
        - packageId
        - date
        - metric
        - value
      type: object
      properties:
        packageId:
          description: Package unique string identifier
          type: string
        date:
          description: Date on which business metric was collected.
          type: string
          format: date
          example: '2023-12-31'
        username:
          description: Name of the user that has been counted for a specific metric.
          type: string
        metric:
          description: Name of business metric.
          type: string
          example: comparisons_called
        value:
          description: Value associated with business metric.
          type: integer
    VersionStatusEnum:
      description: Package version status
      type: string
      enum:
        - draft
        - release
        - archived
    ApiType:
      title: apiType
      type: string
      enum:
        - rest
        - graphql
        - protobuf
        - asyncapi
  examples:
    IncorrectInputParameters:
      description: Incorrect input parameters
      value:
        status: 400
        code: "APIHUB-COMMON-4001"
        message: "Incorrect input parameters"
    InternalServerError:
      description: Default internal server error
      value:
        status: 500
        code: "APIHUB-8000"
        reason: "InternalServerError"
        message: "InternalServerError"
  securitySchemes:
    BearerAuth:
      type: http
      description: Bearer token authentication. Default secutity scheme for API usage.
      scheme: bearer
      bearerFormat: JWT
    CookieAuth:
      type: apiKey
      in: cookie
      name: apihub-access-token
      description: Authentication via the `apihub-access-token` cookie.
    api-key:
      type: apiKey
      description: Api-key authentication.
      name: api-key
      in: header
    PersonalAccessToken:
      type: apiKey
      description: Authentication by personal access token.
      name: X-Personal-Access-Token
      in: header

